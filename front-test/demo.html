<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TimeLocker API å¿«é€Ÿæµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        
        .section h2 {
            color: #555;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #666;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        textarea {
            height: 100px;
            resize: vertical;
            font-family: monospace;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .status {
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-weight: 500;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .response {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>TimeLocker API å¿«é€Ÿæµ‹è¯•</h1>
        
        <!-- é…ç½®åŒºåŸŸ -->
        <div class="section">
            <h2>âš™ï¸ é…ç½®</h2>
            <div class="form-group">
                <label>åç«¯APIåœ°å€:</label>
                <input type="text" id="apiUrl" value="http://localhost:8080" placeholder="http://localhost:8080">
            </div>
        </div>

        <!-- é’±åŒ…è¿æ¥åŒºåŸŸ -->
        <div class="section">
            <h2>ğŸ”— é’±åŒ…è¿æ¥æµ‹è¯•</h2>
            <div id="walletStatus" class="status info">
                è¯·å…ˆè¿æ¥é’±åŒ…
            </div>
            <button id="connectBtn">è¿æ¥é’±åŒ…</button>
            <div class="form-group" style="margin-top: 15px;">
                <label>é’±åŒ…åœ°å€:</label>
                <input type="text" id="walletAddress" readonly placeholder="æœªè¿æ¥">
            </div>
        </div>

        <!-- APIæµ‹è¯•åŒºåŸŸ -->
        <div class="section">
            <h2>ğŸ” è®¤è¯APIæµ‹è¯•</h2>
            
            <!-- é’±åŒ…è®¤è¯ -->
            <h3>1. é’±åŒ…è¿æ¥è®¤è¯</h3>
            <button id="authBtn" disabled>å¼€å§‹è®¤è¯</button>
            <div class="form-group">
                <label>è®¤è¯å“åº”:</label>
                <textarea id="authResponse" readonly placeholder="ç­‰å¾…è®¤è¯..."></textarea>
            </div>
            
            <!-- åˆ·æ–°ä»¤ç‰Œ -->
            <h3>2. åˆ·æ–°ä»¤ç‰Œ</h3>
            <button id="refreshBtn" disabled>åˆ·æ–°Token</button>
            <div class="form-group">
                <label>åˆ·æ–°å“åº”:</label>
                <textarea id="refreshResponse" readonly placeholder="ç­‰å¾…åˆ·æ–°..."></textarea>
            </div>
            
            <!-- è·å–ç”¨æˆ·èµ„æ–™ -->
            <h3>3. è·å–ç”¨æˆ·èµ„æ–™</h3>
            <button id="profileBtn" disabled>è·å–èµ„æ–™</button>
            <div class="form-group">
                <label>ç”¨æˆ·èµ„æ–™:</label>
                <textarea id="profileResponse" readonly placeholder="ç­‰å¾…è·å–..."></textarea>
            </div>
        </div>

        <!-- ä»¤ç‰Œä¿¡æ¯ -->
        <div class="section">
            <h2>ğŸ”‘ ä»¤ç‰Œä¿¡æ¯</h2>
            <div class="form-group">
                <label>Access Token:</label>
                <textarea id="accessToken" readonly placeholder="æš‚æ— "></textarea>
            </div>
            <div class="form-group">
                <label>Refresh Token:</label>
                <textarea id="refreshToken" readonly placeholder="æš‚æ— "></textarea>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ethers@6.8.1/dist/ethers.umd.min.js"></script>
    <script>
        class SimpleWalletTest {
            constructor() {
                this.provider = null;
                this.signer = null;
                this.walletAddress = null;
                this.accessToken = null;
                this.refreshToken = null;
                this.apiBaseUrl = 'http://localhost:8080';
                
                this.init();
            }

            init() {
                // ç»‘å®šäº‹ä»¶
                document.getElementById('connectBtn').addEventListener('click', () => this.connectWallet());
                document.getElementById('authBtn').addEventListener('click', () => this.authenticate());
                document.getElementById('refreshBtn').addEventListener('click', () => this.refreshToken());
                document.getElementById('profileBtn').addEventListener('click', () => this.getProfile());
                
                document.getElementById('apiUrl').addEventListener('change', (e) => {
                    this.apiBaseUrl = e.target.value;
                });

                this.updateStatus('è¯·å…ˆè¿æ¥é’±åŒ…', 'info');
            }

            async connectWallet() {
                try {
                    if (typeof window.ethereum === 'undefined') {
                        throw new Error('è¯·å®‰è£…MetaMaské’±åŒ…');
                    }

                    this.updateStatus('æ­£åœ¨è¿æ¥é’±åŒ…...', 'info');
                    
                    // è¿æ¥é’±åŒ…
                    this.provider = new ethers.BrowserProvider(window.ethereum);
                    await this.provider.send("eth_requestAccounts", []);
                    this.signer = await this.provider.getSigner();
                    this.walletAddress = await this.signer.getAddress();

                    // æ›´æ–°UI
                    document.getElementById('walletAddress').value = this.walletAddress;
                    document.getElementById('authBtn').disabled = false;
                    
                    this.updateStatus(`é’±åŒ…è¿æ¥æˆåŠŸ: ${this.walletAddress}`, 'success');

                } catch (error) {
                    console.error('è¿æ¥é’±åŒ…å¤±è´¥:', error);
                    this.updateStatus(`è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                }
            }

            async authenticate() {
                try {
                    if (!this.signer) {
                        throw new Error('è¯·å…ˆè¿æ¥é’±åŒ…');
                    }

                    this.updateStatus('æ­£åœ¨è¯·æ±‚ç­¾å...', 'info');

                    // ç”Ÿæˆç­¾åæ¶ˆæ¯
                    const timestamp = Date.now();
                    const message = `TimeLocker Login Nonce: ${timestamp}`;

                    // è¯·æ±‚ç­¾å
                    const signature = await this.signer.signMessage(message);
                    
                    // è·å–é“¾ID
                    const network = await this.provider.getNetwork();
                    const chainId = Number(network.chainId);

                    // æ„é€ è¯·æ±‚
                    const requestData = {
                        wallet_address: this.walletAddress,
                        signature: signature,
                        message: message,
                        chain_id: chainId
                    };

                    this.updateStatus('æ­£åœ¨å‘é€è®¤è¯è¯·æ±‚...', 'info');

                    // å‘é€è¯·æ±‚
                    const response = await this.callAPI('/api/v1/auth/wallet-connect', 'POST', requestData);
                    
                    document.getElementById('authResponse').value = JSON.stringify(response, null, 2);

                    if (response.success) {
                        this.accessToken = response.data.access_token;
                        this.refreshToken = response.data.refresh_token;
                        
                        document.getElementById('accessToken').value = this.accessToken;
                        document.getElementById('refreshToken').value = this.refreshToken;
                        document.getElementById('refreshBtn').disabled = false;
                        document.getElementById('profileBtn').disabled = false;
                        
                        this.updateStatus('è®¤è¯æˆåŠŸ!', 'success');
                    } else {
                        throw new Error(response.error?.message || 'è®¤è¯å¤±è´¥');
                    }

                } catch (error) {
                    console.error('è®¤è¯å¤±è´¥:', error);
                    this.updateStatus(`è®¤è¯å¤±è´¥: ${error.message}`, 'error');
                    document.getElementById('authResponse').value = JSON.stringify({
                        error: error.message
                    }, null, 2);
                }
            }

            async refreshToken() {
                try {
                    if (!this.refreshToken) {
                        throw new Error('æ²¡æœ‰åˆ·æ–°ä»¤ç‰Œ');
                    }

                    this.updateStatus('æ­£åœ¨åˆ·æ–°ä»¤ç‰Œ...', 'info');

                    const requestData = {
                        refresh_token: this.refreshToken
                    };

                    const response = await this.callAPI('/api/v1/auth/refresh', 'POST', requestData);
                    
                    document.getElementById('refreshResponse').value = JSON.stringify(response, null, 2);

                    if (response.success) {
                        this.accessToken = response.data.access_token;
                        this.refreshToken = response.data.refresh_token;
                        
                        document.getElementById('accessToken').value = this.accessToken;
                        document.getElementById('refreshToken').value = this.refreshToken;
                        
                        this.updateStatus('ä»¤ç‰Œåˆ·æ–°æˆåŠŸ!', 'success');
                    } else {
                        throw new Error(response.error?.message || 'åˆ·æ–°å¤±è´¥');
                    }

                } catch (error) {
                    console.error('åˆ·æ–°å¤±è´¥:', error);
                    this.updateStatus(`åˆ·æ–°å¤±è´¥: ${error.message}`, 'error');
                    document.getElementById('refreshResponse').value = JSON.stringify({
                        error: error.message
                    }, null, 2);
                }
            }

            async getProfile() {
                try {
                    if (!this.accessToken) {
                        throw new Error('æ²¡æœ‰è®¿é—®ä»¤ç‰Œ');
                    }

                    this.updateStatus('æ­£åœ¨è·å–ç”¨æˆ·èµ„æ–™...', 'info');

                    const response = await this.callAPI('/api/v1/auth/profile', 'GET', null, {
                        'Authorization': `Bearer ${this.accessToken}`
                    });
                    
                    document.getElementById('profileResponse').value = JSON.stringify(response, null, 2);

                    if (response.success) {
                        this.updateStatus('è·å–ç”¨æˆ·èµ„æ–™æˆåŠŸ!', 'success');
                    } else {
                        throw new Error(response.error?.message || 'è·å–å¤±è´¥');
                    }

                } catch (error) {
                    console.error('è·å–èµ„æ–™å¤±è´¥:', error);
                    this.updateStatus(`è·å–å¤±è´¥: ${error.message}`, 'error');
                    document.getElementById('profileResponse').value = JSON.stringify({
                        error: error.message
                    }, null, 2);
                }
            }

            async callAPI(endpoint, method = 'GET', data = null, headers = {}) {
                const url = `${this.apiBaseUrl}${endpoint}`;
                const config = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        ...headers
                    }
                };

                if (data) {
                    config.body = JSON.stringify(data);
                }

                const response = await fetch(url, config);
                return await response.json();
            }

            updateStatus(message, type) {
                const statusEl = document.getElementById('walletStatus');
                statusEl.textContent = message;
                statusEl.className = `status ${type}`;
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            window.walletTest = new SimpleWalletTest();
        });
    </script>
</body>
</html> 